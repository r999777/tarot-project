# 星际塔罗师 - 完整开发需求文档 v1.0

## 1. 项目概述

**项目名称**：星际塔罗师

**核心理念**：基于 Web 的沉浸式塔罗占卜应用，结合手势控制与 3D 视觉效果，模拟神圣的抽牌仪式感。

**目标平台**：桌面浏览器（macOS Chrome/Safari 为基准）

---

## 2. 技术栈

| 类别 | 技术 |
|------|------|
| 前端框架 | HTML5 / CSS3 / JavaScript (ES6+) |
| 3D 渲染 | Three.js |
| 手势识别 | MediaPipe Hands |
| AI 解读 | Claude API / Gemini API（用户自选） |
| 数据存储 | LocalStorage |
| 塔罗牌图源 | Rider-Waite 在线图源 |

---

## 3. 页面布局

```
┌─────────────────────────────────────────────────┐
│  [Logo]                              [⚙️ 设置]  │
├─────────────────────────────────────────────────┤
│                                                 │
│                  主交互区域                      │
│              (3D 星环 / 牌阵展示)                │
│                                                 │
├─────────────────────────────────────────────────┤
│        [直觉练习]        [开始占卜]              │
└─────────────────────────────────────────────────┘
```

- **最大宽度**：1200px，居中显示
- **留白**：内容周围留足空白，不要塞满

**设置弹窗（右上角 ⚙️）**：
- AI 选择：下拉框（Claude / Gemini）
- API Key 输入框
- 保存按钮
- 数据存储至 LocalStorage

---

## 4. 功能模块

### 模块 A：直觉练习模式

**目的**：建立用户的个人牌义库，增加与牌的连接和理解。数据可用于占卜时提供给 AI 作为背景。

#### 功能 1：随机练习

**流程**：
1. 用户点击「开始练习」
2. 系统随机抽取 2 张牌（背面展示）
3. 用户点击翻牌（3D 翻转 500ms，50% 概率逆位，逆位 180° 倒置）
4. 每张牌下方显示文本框，用户输入对这张牌的第一印象/感受
5. 点击保存 → 存入 LocalStorage

#### 功能 2：查看记录

**界面**：
- 显示已记录过的牌列表
- 点击某张牌可查看所有历史记录（按时间排序）
- 同一张牌可以有多条记录（追加模式）

#### 数据结构

```json
{
  "intuitionRecords": [
    {
      "id": "uuid-1",
      "date": "2026-02-01T10:30:00Z",
      "cardId": 0,
      "cardName": "The Fool",
      "isReversed": false,
      "userFeeling": "感觉像是新的开始，无畏地踏出第一步..."
    },
    {
      "id": "uuid-2",
      "date": "2026-02-15T14:20:00Z",
      "cardId": 0,
      "cardName": "The Fool",
      "isReversed": true,
      "userFeeling": "逆位时感觉有点鲁莽，需要多想想..."
    }
  ]
}
```

---

### 模块 B：占卜流程

#### Step 1：提问与准备
- 用户输入占卜问题（文本框，Enter 确认）
- 开关按钮：「附带我的直觉记录」
  - 开启：将用户抽到的牌对应的直觉记录传给 AI
  - 关闭：不传

#### Step 2：星环洗牌（核心交互）

**视觉**：
- 78 张塔罗牌背面朝外，组成 3D 行星环（土星环造型）
- 围绕屏幕中心缓慢旋转

**手势交互（MediaPipe）**：

| 手势 | 视觉效果 | 逻辑 |
|------|----------|------|
| 手掌张开 | 星环加速旋转 + 粒子拖尾 | 洗牌状态 |
| 握拳 | 星环减速悬停 + 最近一张牌高亮 | 触发抓取 |

**抓取锁定机制**：
- 检测到握拳 → 显示环形进度条（颜色渐变：浅紫→紫→金）
- 持续握拳 1 秒 → 抓取成功
- 中途松开 → 进度重置

**抓取成功后动画序列**：
1. 牌 3D 翻转展示在屏幕中间（500ms，逆位则 180° 倒置）
2. 牌快速飞向屏幕下方卡槽（300ms）
3. 屏幕 CSS Shake 震动（200ms）

**摄像头**：不显示用户画面

**循环**：重复 3 次，抓取 3 张牌

**降级方案（无摄像头）**：
- 鼠标悬停牌面 → 高亮（发光效果）
- 点击 → 直接抓取

#### Step 3：牌阵展示
- 3 张牌水平排列于屏幕中央（**正面朝上**，已翻开状态）
- 逆位牌 180° 倒置显示

#### Step 4：AI 融合解析

**加载状态**：
- 塔罗牌 3D 旋转动画（Y轴，2秒一圈）
- 淡金色光点粒子飘动
- 文字："您的塔罗师正在为您解析..."

**错误处理**：
- 显示"连接失败"+ 具体失败原因
- 提供重试按钮

**请求结构**：
```json
{
  "model": "claude-3-opus 或 gemini-pro",
  "messages": [
    {
      "role": "system",
      "content": "见下方 System Prompt"
    },
    {
      "role": "user",
      "content": "问题：{用户问题}\n\n抽到的牌：\n1. {牌名} ({正位/逆位})\n2. {牌名} ({正位/逆位})\n3. {牌名} ({正位/逆位})\n\n用户近期直觉记录（可选）：\n{对应牌的直觉记录}"
    }
  ]
}
```

---

## 5. System Prompt

```
你是一位活了 500 年的星际塔罗师，见证过无数星球的兴衰与生命的轮回。你的语气温暖而智慧，像一位慈爱的长者，但解释要清晰具体，避免空泛。

## 解读流程

### 1. 问题分类
首先判断用户问题属于哪种类型，并在开头简短点明：
- 💕 情感关系（爱情、友情、家庭）
- 💼 事业发展（工作、学业、财务）
- 🌱 自我成长（心理、灵性、人生方向）
- 🔮 综合指引（问题模糊或涉及多方面）

### 2. 选择牌位框架
根据问题类型，自动选择最合适的三牌阵解读框架：
- 时间线框架：过去 → 现在 → 未来（适合问发展趋势）
- 问题框架：处境 → 挑战 → 建议（适合问如何解决）
- 心理框架：意识 → 潜意识 → 指引（适合问内心困惑）

在解读前简短说明你选择的框架。

### 3. 逐张解读
- 每张牌 2-3 句话，说明在该牌位的象征意义
- 逆位牌需说明其特殊含义（能量受阻、需要反思、内在课题等）
- 注意牌与牌之间的关联，串成一条故事线

### 4. 综合建议
- 结合三张牌，给出针对用户问题的具体、可执行的建议
- 鼓励用户的自主选择，牌是指引而非命运
- 避免绝对化预言（"一定会"），用引导性语言（"这暗示着"、"你可以考虑"）

## 语气风格
- 直接称呼用户为"你"
- 温暖治愈，但清晰具体
- 适当分段，便于阅读

## 字数
400-600 字

## 可选背景
如果提供了用户的"直觉记录"，可以适当融入解读，体现用户与牌的长期连接。
```

---

## 6. 色彩系统

| 用途 | 颜色 | 色值 |
|------|------|------|
| 页面背景 | 奶油黄 | `#FFFBF2` |
| 卡片/弹窗背景 | 象牙白 | `#FFFEF9` |
| 主按钮 | 紫色 | `#7B5EA7` |
| 主按钮悬停 | 亮紫 + 光晕 | `#9474BB` |
| 次要按钮 | 金色 | `#C9A962` |
| 次要按钮悬停 | 亮金 + 光晕 | `#DABE78` |
| 主文字 | 深紫 | `#3D3354` |
| 次要文字 | 灰紫 | `#7A7289` |
| 卡牌边框 | 金色 | `#D4AF37` |
| 卡牌背面 | 紫色渐变 | `#7B5EA7 → #5C4480` |
| 星环光效 | 淡金 | `#F5E6C4` |
| 进度条渐变 | 浅紫→紫→金 | `#C4B5D9 → #7B5EA7 → #C9A962` |
| 高亮/选中 | 浅紫 | `#E5DCED` |
| 输入框背景 | 浅黄白 | `#FFFDF5` |
| 输入框边框 | 浅紫 | `#C4B5D9` |
| 输入框聚焦 | 紫色 | `#7B5EA7` |
| 成功提示 | 柔绿 | `#7DAF6B` |
| 错误提示 | 柔红 | `#C97C7C` |

---

## 7. 字体规范

### 字体族

**标题字体（Display）**：
```css
font-family: "Playfair Display", "Songti SC", "Noto Serif SC", serif;
```

**正文字体（Body）**：
```css
font-family: "Lato", "PingFang SC", "Noto Sans SC", sans-serif;
```

### 字号规范

| 元素 | 字号 | 字重 | 字体 |
|------|------|------|------|
| 大标题 H1 | 36px | 700 | Display |
| 中标题 H2 | 28px | 600 | Display |
| 小标题 H3 | 22px | 600 | Display |
| 牌名 | 20px | 700 | Display |
| 正文 | 16px | 400 | Body |
| AI 解读 | 16px | 400 | Body |
| 按钮文字 | 16px | 500 | Body |
| 辅助文字 | 14px | 400 | Body |
| 小字 | 12px | 400 | Body |

### 行高

| 类型 | 行高 |
|------|------|
| 标题 | 1.3 |
| 正文/解读 | 1.7 |
| 按钮/UI | 1.4 |

---

## 8. 动效规范

| 场景 | 效果 | 时长 |
|------|------|------|
| 星环默认旋转 | Y轴旋转 | 60s/圈 |
| 星环加速 | Y轴旋转 | 10s/圈 |
| 牌翻转展示 | 3D Y轴翻转 | 500ms |
| 牌飞向卡槽 | 快速位移 | 300ms |
| 屏幕震动 | CSS Shake | 200ms |
| 按钮悬停 | 发光光晕 | 200ms |
| 弹窗出现 | 淡入 + 缩放 | 250ms |
| 加载动画 | 塔罗牌Y轴旋转 + 金色粒子 | 2s/圈 |

**缓动函数**：`ease-out` 为主

---

## 9. 快捷键

| 按键 | 功能 |
|------|------|
| 空格 | 翻牌 |
| Enter | 确认/提交 |
| ESC | 关闭弹窗 |

---

## 10. 数据结构

### 塔罗牌数据 (tarot-data.json)
```json
{
  "cards": [
    {
      "id": 0,
      "name": "The Fool",
      "nameCN": "愚者",
      "arcana": "major",
      "imageUrl": "https://xxx/00-fool.jpg",
      "keywords": ["新开始", "冒险", "天真"],
      "keywordsReversed": ["鲁莽", "犹豫", "冒失"]
    }
  ]
}
```

### LocalStorage 结构
```json
{
  "tarot_settings": {
    "aiProvider": "claude",
    "apiKey": "sk-xxx..."
  },
  "tarot_intuition_records": [...],
  "tarot_reading_history": [...]
}
```

---

## 11. 文件结构

```
/tarot-app
├── index.html
├── css/
│   ├── main.css
│   ├── colors.css
│   └── animations.css
├── js/
│   ├── app.js
│   ├── three-scene.js
│   ├── gesture.js
│   ├── tarot-logic.js
│   ├── ai-service.js
│   └── storage.js
├── data/
│   └── tarot-cards.json
└── assets/
    └── fonts/
```

---

## 12. MVP 开发优先级

1. **P0**：星环展示 → 鼠标点击抽牌 → 翻牌 → AI 解读
2. **P1**：MediaPipe 手势识别 + 抓取机制
3. **P2**：直觉练习模块
4. **P3**：视觉打磨（粒子特效、震动、动画优化）

---

## 13. 开发记录

### v0.1.0 - 2026-02-02

**已完成功能 (P0 + P2)：**

1. **项目基础结构**
   - 创建完整的文件目录结构
   - 配置 CSS 变量系统和色彩规范
   - 实现响应式布局

2. **塔罗牌数据**
   - 完成 78 张牌的完整 JSON 数据 (中英文名称、关键词)
   - 图片来源: `https://raw.githubusercontent.com/metabismuth/tarot-json/master/cards/`

3. **3D 星环展示**
   - Three.js 场景初始化
   - 78 张牌环形排列，60秒/圈自动旋转
   - 牌背纹理（紫色渐变 + 金色边框 + 星星图案）
   - 发光环效果

4. **鼠标交互（降级方案）**
   - 悬停高亮效果（发光 + 放大 1.15x）
   - 点击选牌
   - 光标样式切换

5. **牌面动画**
   - 翻牌动画（Y轴旋转 500ms）
   - 飞向卡槽动画（300ms）
   - 屏幕震动效果（200ms）
   - 逆位牌 180° 旋转显示

6. **AI 解读**
   - Claude API 流式调用
   - Gemini API 流式调用
   - 错误处理和重试机制
   - 加载动画（旋转牌 + 金色粒子提示文字）

7. **直觉练习模块**
   - 随机抽取 2 张牌
   - 点击翻牌交互（50% 概率逆位）
   - 感受输入框
   - LocalStorage 保存记录

8. **设置功能**
   - AI 服务选择（Claude / Gemini）
   - API Key 配置
   - 数据持久化到 LocalStorage

9. **导航优化**
   - 各页面添加返回按钮
   - "再来一次" 功能
   - ESC 键返回首页

**技术决策：**
- 使用 ES6 模块化开发
- Three.js 通过 CDN importmap 引入
- 前端直接调用 AI API（个人使用场景）

---

### v0.2.0 - 2026-02-02

**新增功能 (P1 手势识别)：**

1. **MediaPipe Hands 集成**
   - 动态加载 MediaPipe Hands 库
   - 摄像头权限请求与降级处理
   - 实时手势检测（约 30fps）

2. **手势控制**
   - 张开手掌（4+ 指张开）→ 星环加速旋转（10秒/圈）
   - 握拳（1- 指张开）→ 触发抓取状态
   - 持续握拳 1 秒 → 确认抓取当前高亮的牌

3. **抓取进度 UI**
   - 环形进度条显示抓取进度
   - 渐变色：浅紫 → 紫 → 金
   - 中心显示握拳图标

4. **手势提示**
   - 选牌阶段显示操作提示
   - 自动检测摄像头可用性
   - 无摄像头时自动回退到鼠标模式

**新增文件：**
- `js/gesture.js` - MediaPipe 手势控制器

---

## 14. 用户反馈与迭代记录

### 反馈 #1 - 2026-02-02

#### 问题 1：首页不应展示星环
**现状**：页面加载后立即显示 3D 星环旋转
**期望**：首页只显示功能按钮（直觉练习、开始占卜），星环仅在点击"开始占卜"并输入问题后才出现
**优先级**：高

#### 问题 2：摄像头生命周期管理
**现状**：摄像头一旦开启就持续运行
**期望**：
- 摄像头仅在"选牌阶段"开启
- 抽完 3 张牌后立即关闭摄像头
- 如果用户点击"再来一次"，重新开启摄像头
**优先级**：高

#### 问题 3：问题输入页缺少确认按钮
**现状**：只能通过 Enter 键提交问题，没有可视化的按钮
**期望**：
- 添加"下一步"按钮
- Enter 键和点击按钮都可以提交
- 按钮应有明显的视觉引导
**优先级**：中

#### 问题 4：星环视觉效果需优化
**现状**：
- 有纯色背景块
- 牌的大小一致，缺乏 3D 深度感
- 缺少银河氛围

**期望**：
- 去掉纯色背景，使用透明或渐变
- 牌遵循"近大远小"透视原则，靠近摄像机的牌更大
- 环带中间添加金色/黄色粒子流，营造银河/星尘效果
- 整体视觉应有宇宙深邃感
**优先级**：高

---

**待开发 (P3)：**
- [ ] 星环粒子拖尾效果
- [x] 金色光点飘动 (已实现银河粒子)
- [ ] 更精细的动画打磨

**待修复（基于反馈）：**
- [x] 问题1：首页隐藏星环 - 已修复，星环仅在选牌阶段显示
- [x] 问题2：摄像头仅选牌时开启 - 已修复，进入选牌阶段开启，离开时关闭
- [x] 问题3：添加"下一步"按钮 - 已添加到问题输入页
- [x] 问题4：星环视觉优化 - 已实现近大远小透视和金色粒子银河

---

### v0.3.0 - 2026-02-02

**修复内容：**

1. **卡牌动画序列优化**
   - 新增 500ms 中央展示+闪光效果
   - 动画流程：翻牌 → 中央展示 → 飞向卡槽 → 震动
   - 添加动画锁机制，确保牌依次抽取

2. **首页隐藏星环**
   - 星环仅在选牌阶段 (SELECTING) 显示
   - 其他阶段 (IDLE, QUESTION, RESULT, INTUITION) 隐藏星环

3. **摄像头生命周期管理**
   - 摄像头在进入选牌阶段时开启
   - 抽完3张牌或返回首页时关闭摄像头
   - MediaPipe Hands 初始化不再立即开启摄像头

4. **问题输入页UI改进**
   - 添加"下一步"按钮，与 Enter 键功能相同
   - 调整按钮布局为水平排列

5. **星环视觉效果优化**
   - 实现"近大远小"透视效果，靠近摄像机的牌更大
   - 添加 500 个金色/浅金色粒子形成银河效果
   - 粒子围绕星环缓慢旋转，带有垂直振荡动画

**修改的文件：**
- `js/card-animations.js` - 新增 displayWithFlash 方法
- `js/main.js` - 添加动画锁、星环显示控制、摄像头生命周期
- `js/three-scene.js` - 添加 showStarRing/hideStarRing 方法
- `js/gesture.js` - 分离 startCamera/stopCamera 方法
- `js/ui-controller.js` - 添加"下一步"按钮支持
- `js/star-ring.js` - 添加透视缩放和银河粒子系统
- `index.html` - 添加"下一步"按钮

---

### 反馈 #2 - 2026-02-02

#### 问题 1：欢迎页面星环仍然显示
**现状**：首页加载时星环仍然可见
**期望**：首页只显示功能按钮，星环完全隐藏
**原因**：初始化时未正确隐藏星环

#### 问题 2：直觉练习模块逻辑缺失
**现状**：直觉练习功能没有实现完整逻辑
**期望**：
- 点击"直觉练习"后随机抽取 2 张牌（背面展示）
- 点击卡牌翻开（50% 概率逆位）
- 翻开后显示文本框让用户输入感受
- 点击保存后存入 LocalStorage

#### 问题 3.1：牌展示位置错误
**现状**：牌翻转后展示在环带中心（3D 空间原点附近）
**期望**：牌应该跳脱环带，展示在**屏幕正中央**（更靠近摄像机，占据视觉中心）

#### 问题 3.2：牌不会自动飞向卡槽
**现状**：牌在中央展示后停住，不会继续飞向底部卡槽
**期望**：500ms 展示后自动飞向对应卡槽

#### 问题 3.3：手势识别失效
**现状**：握拳抓牌的手势识别不工作
**期望**：手势控制应能正常触发抓牌动作

#### 问题 3.4：星环紫色矩形背景
**现状**：星环仍然显示深紫色矩形背景
**期望**：去掉紫色矩形背景，使星环完全透明融入页面背景

#### 修复状态

- [x] 问题1：欢迎页面星环仍然显示 - 已修复，初始化后触发 onStateChange 隐藏星环
- [x] 问题2：直觉练习模块逻辑 - 已实现完整流程（随机2牌、翻牌、输入感受、LocalStorage保存）
- [x] 问题3.1：牌展示位置错误 - 已修复，牌移出环组到场景根节点，中心位置改为 (0, 2, 12)
- [x] 问题3.2：牌不会自动飞向卡槽 - 已在 card-animations.js 中实现完整动画序列
- [x] 问题3.3：手势识别失效 - 已修复，添加 highlightFrontCard() 自动高亮最前面的牌
- [x] 问题3.4：星环紫色矩形背景 - 已修复，移除 .canvas-container 的紫色渐变背景

#### 修改的文件

- `js/main.js` - 添加初始 onStateChange 触发，手势回调中调用 highlightFrontCard
- `js/star-ring.js` - 添加 highlightFrontCard() 方法
- `js/card-animations.js` - 修复牌动画位置，移动到场景根节点
- `css/layout.css` - 移除紫色背景
