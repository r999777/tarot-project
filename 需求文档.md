# 星际塔罗师 - 完整开发需求文档

## 版本历史

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| v0.1 | 2026-02-02 | 核心功能完成：星环、鼠标抽牌、AI 解读、追问 |
| v0.2 | 2026-02-03 | 新增用户引导系统 |
| v0.3 | 2026-02-04 | 需求文档全面更新：与实际实现同步 |
| v0.4 | 2026-02-04 | 直觉练习模块 + AI 直觉注入系统完成 |

---

## 1. 项目概述

**项目名称**：星际塔罗师

**核心理念**：基于 Web 的沉浸式塔罗占卜应用，结合手势控制与 3D 视觉效果，模拟神圣的抽牌仪式感。

**目标平台**：桌面浏览器（macOS Chrome/Safari 为基准）

---

## 2. 技术栈

| 类别 | 技术 |
|------|------|
| 前端框架 | HTML5 / CSS3 / JavaScript (ES6+) |
| 3D 渲染 | Three.js |
| 手势识别 | MediaPipe Hands |
| AI 解读 | Claude API / Gemini API（用户自选） |
| 数据存储 | LocalStorage |
| 塔罗牌图源 | Rider-Waite 在线图源 |

### 外部依赖

| 库 | 版本 | CDN |
|---|---|---|
| Three.js | 0.160.0 | unpkg |
| MediaPipe Hands | 0.4.1675469240 | jsdelivr |
| marked.js | latest | jsdelivr |

### API 调用注意

- **Claude**: 浏览器直调需添加 header `anthropic-dangerous-direct-browser-access: true`
- **Gemini**: 使用流式接口 `?alt=sse`，意图分类用 `temperature: 0`，解读用 `temperature: 1.2`

---

## 3. 页面布局

### 首页

```
┌─────────────────────────────────────────────────┐
│                                                 │
│                   ✨ Logo ✨                     │
│                  星际塔罗师                      │
│                                                 │
│        [ 开始占卜 ]    [ 直觉练习 ]              │
│                                                 │
└─────────────────────────────────────────────────┘
                               [⚙️] ← 右上角悬浮
```

**设置弹窗（右上角 ⚙️）**：
- AI 选择：下拉框（Claude / Gemini）
- API Key 输入框
- 保存按钮

---

## 4. 功能模块

### 模块 A：直觉练习模式 `[已实现]`

**目的**：建立用户的个人牌义库，增加与牌的连接和理解。数据可用于占卜时提供给 AI 作为背景。

#### 功能 1：随机练习

**流程**：
1. 用户点击「开始练习」
2. 系统随机抽取 2 张牌（背面展示）
3. 用户点击翻牌（3D 翻转 500ms，50% 概率逆位，逆位 180° 倒置）
4. 每张牌下方显示文本框，用户输入对这张牌的第一印象/感受
5. 点击保存 → 存入 LocalStorage

#### 功能 2：查看记录

**界面**：
- 显示已记录过的牌列表
- 点击某张牌可查看所有历史记录（按时间排序）
- 同一张牌可以有多条记录（追加模式）

#### 数据结构

```json
{
  "intuitionRecords": [
    {
      "id": "uuid-1",
      "date": "2026-02-01T10:30:00Z",
      "cardId": 0,
      "cardName": "愚者",
      "cardImage": "https://raw.githubusercontent.com/.../m00.jpg",
      "isReversed": false,
      "feeling": "感觉像是新的开始，无畏地踏出第一步..."
    },
    {
      "id": "uuid-2",
      "date": "2026-02-15T14:20:00Z",
      "cardId": 0,
      "cardName": "愚者",
      "cardImage": "https://raw.githubusercontent.com/.../m00.jpg",
      "isReversed": true,
      "feeling": "逆位时感觉有点鲁莽，需要多想想..."
    }
  ]
}
```

---

### 模块 B：占卜流程 `[已实现]`

#### Step 1：提问与准备
- 用户输入占卜问题（扁平输入框，2行高度）
- 开关按钮：「注入星际塔罗师的能量」`[已实现]`
  - 勾选后，AI 将结合开发者的直觉感悟进行解读
  - 三层降级策略：
    1. 未勾选 → 无直觉注入
    2. 勾选 + 有匹配数据 → 注入具体感悟
    3. 勾选 + 无数据 → AI 切换到「高共情模式」
  - 支持正逆位转化：当记录的正逆位与抽到的不同时，标注提示 AI 适当转化
- 点击「进入星环」进入抽牌页面

#### Step 2：星环洗牌（核心交互）

**视觉**：
- 78 张牌背面朝外，组成 3D 行星环
- 围绕屏幕中心旋转（正常 70秒/圈）
- 多色粒子系统（金色 60% + 白色 25% + 浅紫 15%）

**洗牌动画**：
- 紫色粒子先出现，飞向牌的位置
- 牌在粒子飞到 40% 时开始显现
- 多色粒子渐入，紫色粒子渐出

**抓牌方式选择**（牌出现后显示）：
- 「开启摄像头 · 手势抓牌」
- 「鼠标点击 · 触碰命运」

**手势交互（MediaPipe）**：

| 手势 | 效果 |
|------|------|
| 张开手掌（持续 300ms） | 星环加速（10秒/圈）+ 激活抓取资格 |
| 握拳 | 星环减速（30秒/圈）+ 粒子汇聚 |
| 持续握拳 1秒 | 确认抓取 |
| 松开拳头 | 取消抓取，牌归位 |

**鼠标交互（降级方案）**：
- 悬停高亮（发光 + 放大 1.1x）
- 点击 → 直接抓取

**抓取成功动画**：
1. 粒子淡出 + 牌背显现（500ms）
2. Y轴翻转显示正面（600ms，逆位 Z轴旋转 180°）
3. 飞向卡槽（300ms）

**循环**：重复 3 次

#### Step 3：牌阵展示
- 3 张牌水平排列于卡槽（正面朝上）
- 标签：过去 / 现在 / 未来
- 「揭示命运」按钮（选满 3 张后激活）

#### Step 4：AI 融合解析

**解读结果页面**：
- 顶部：三张牌缩小展示
- 中间：AI 解读内容（Markdown 渲染）
- 底部：追问输入框

**加载状态**：
- 旋转指示器
- 文字："星际塔罗师正在解读命运..."

**错误处理**：
- 显示错误原因 + 重试按钮

**追问功能**：
- 保留原答案，追问内容追加显示
- 支持多轮对话上下文

---

## 5. AI 智能 Prompt 系统

### 5.1 两阶段调用架构 (Gemini)

| 阶段 | 用途 | Temperature |
|------|------|-------------|
| 第一阶段 | 意图分类 (A/B/C/D) | 0 |
| 第二阶段 | 塔罗解读 | 1.2 |

### 5.2 问题分类

| 类型 | 代码 | 适用场景 | 示例 |
|------|------|----------|------|
| 直球结果型 | A | Yes/No 问题 | 能不能发财？他喜欢我吗？ |
| 运势预测型 | B | 时间段运势 | 下周运势如何？最近财运？ |
| 深度分析型 | C | 迷茫求建议 | 我该怎么办？为什么会这样？ |
| 无效输入 | D | 过滤垃圾输入 | "1"、乱码、与塔罗无关 |

### 5.3 三套 Prompt 模板

**模式 A (直球结果型)**:
- 角色：星际塔罗预言家（直白不绕弯）
- 输出：预测结论 → 关键信号 → 变数因素 → 避坑指南

**模式 B (运势预测型)**:
- 角色：星际塔罗气象员（能量流动视角）
- 输出：整体运势★ → 能量趋势 → 核心领域 → 开运指南

**模式 C (深度分析型)** - 默认:
- 角色：星际塔罗咨询师（心理学+象征学）
- 输出：核心洞察 → 命运流转(过去/现在/未来) → 星际指引

### 5.4 动态特性

- **当前日期注入**: Prompt 顶部包含 `{current_date}`，运行时替换为真实日期
- **无效输入处理**: D 类返回友好提示，引导用户重新提问
- **追问上下文**: 多轮对话保持角色一致性

> 完整 Prompt 内容见 `js/config.js`

---

## 6. 色彩系统

| 用途 | 颜色 | 色值 |
|------|------|------|
| 页面背景 | 奶油黄 | `#FFFBF2` |
| 卡片/弹窗背景 | 象牙白 | `#FFFEF9` |
| 主按钮 | 紫色 | `#7B5EA7` |
| 主按钮悬停 | 亮紫 | `#9474BB` |
| 次要按钮 | 金色 | `#C9A962` |
| 次要按钮悬停 | 亮金 | `#DABE78` |
| 主文字 | 深紫 | `#3D3354` |
| 次要文字 | 灰紫 | `#7A7289` |
| 卡牌边框 | 金色 | `#D4AF37` |
| 卡牌背面 | 紫色渐变 | `#7B5EA7 → #5C4480` |
| 星环光效 | 淡金 | `#F5E6C4` |
| 边框/分隔线 | 金色半透明 | `rgba(212, 175, 55, 0.2~0.3)` |
| 卡片阴影 | 淡紫阴影 | `rgba(61, 51, 84, 0.06~0.15)` |
| 激活光晕 | 紫色光晕 | `rgba(123, 94, 167, 0.4~0.7)` |
| 错误提示 | 红色 | `#e74c3c` |

---

## 7. 字体规范

**标题字体（--font-title）**：
```css
font-family: "Playfair Display", "Songti SC", "Noto Serif SC", serif;
```

**正文字体（--font-body）**：
```css
font-family: "Lato", "PingFang SC", "Noto Sans SC", sans-serif;
```

> 详细字号定义见 `index.html` 内联样式的 CSS 变量

---

## 8. 数据结构

### 塔罗牌数据 (tarot-cards.json)
```json
{
  "cards": [
    {
      "id": 0,
      "name": "The Fool",
      "nameCN": "愚者",
      "arcana": "major",
      "imageFilename": "m00.jpg",
      "keywords": ["新开始", "冒险", "天真"],
      "keywordsReversed": ["鲁莽", "犹豫", "冒失"]
    }
  ]
}
```

> 图片 URL 拼接规则：`https://raw.githubusercontent.com/metabismuth/tarot-json/master/cards/{imageFilename}`

### LocalStorage 结构
```json
{
  "tarot_settings": {
    "aiProvider": "claude",
    "apiKey": "sk-xxx..."
  },
  "tarot_intuition_records": [...],
  "tarot_reading_history": [...]
}
```

---

## 9. 文件结构

```
/tarot-project
├── index.html              # 主页面（含内联样式）
├── css/
│   ├── variables.css       # CSS 变量
│   ├── base.css            # 基础样式
│   ├── components.css      # 组件样式
│   ├── layout.css          # 页面布局
│   └── animations.css      # 动画
├── js/
│   ├── main.js             # 应用入口
│   ├── config.js           # 常量配置 & Prompt 模板
│   ├── state.js            # 状态管理
│   ├── storage.js          # LocalStorage 封装
│   ├── tarot-data.js       # 牌数据管理
│   ├── three-scene.js      # Three.js 场景
│   ├── star-ring.js        # 星环逻辑
│   ├── card-animations.js  # 牌面动画 & 粒子系统
│   ├── gesture.js          # MediaPipe 手势识别
│   ├── ai-service.js       # AI API 调用
│   └── debug-controls.js   # 调试工具（相机/卡槽位置）
├── data/
│   └── tarot-cards.json    # 78 张牌数据
├── dev-log.md              # 开发日志
└── 需求文档.md              # 本文档
```

---

## 10. MVP 开发优先级

1. **P0** ✅：星环展示 → 鼠标点击抽牌 → 翻牌 → AI 解读
2. **P1** ✅：MediaPipe 手势识别 + 抓取机制
3. **P2** ✅：直觉练习模块 + AI 直觉注入
4. **P3** ⬜：视觉打磨（粒子特效、震动、动画优化）

---

## 11. 版本管理规范

**每日开发结束时**：
1. 更新本文档顶部的「版本历史」表格
2. 执行 `git add . && git commit -m "vX.X: 变更摘要"`
3. 打标签 `git tag vX.X`

**版本号规则**：
- `v0.x` - 开发阶段
- `v1.0` - 首次发布
- 小版本递增：功能新增或重要修复

---

## 12. 已知问题 / 待优化

- [ ] 手势模式下摄像头权限被拒绝时无降级提示
- [ ] 逆位概率硬编码（30%），未暴露设置项
- [x] 直觉练习模块未实现 → **已完成**（2026-02-04）
- [ ] 移动端适配未完成
