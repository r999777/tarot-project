# 星际塔罗师 - 开发日志

## 项目概述
基于 Web 的沉浸式塔罗占卜应用，结合 3D 视觉效果与手势控制。

---

## 已完成模块

### 1. 基础架构
- [x] `js/config.js` - 配置常量（场景、动画、颜色、相机参数）
- [x] `js/state.js` - 应用状态管理
- [x] `js/main.js` - 模块入口与加载测试
- [x] `index.html` - 主页面结构

### 2. 数据层
- [x] `data/tarot-cards.json` - 78张牌完整数据（中英文名、图片URL、关键词）
- [x] `js/tarot-data.js` - 牌数据加载与管理
- [x] `js/storage.js` - LocalStorage 封装

### 3. Three.js 3D 场景
- [x] `js/three-scene.js` - 场景、相机、渲染器、灯光
  - 透明背景渲染
  - 固定相机视角 `{ x: 17.2, y: 0.2, z: -15.2 }`
  - 环境光 + 方向光 + 金色点光源

### 4. 星统环系 ⭐
- [x] `js/star-ring.js` - 核心视觉组件
  - **卡牌环**: 78张牌环形排列，1.2倍大小，间距0.08
  - **牌背纹理**: Canvas 绘制紫色渐变 + 发光边框 + 星星装饰
  - **多色粒子**: 金色2400 + 白色1000 + 浅紫600，高斯分布
  - **星辰纹理**: 圆形径向渐变发光效果
  - **旋转动画**: 60秒/圈（加速时10秒/圈）
  - **粒子飘动**: 缓慢绕圈 + 上下浮动
  - **重建功能**: `rebuild()` 恢复被移除的卡牌

### 5. 手势识别 ⭐
- [x] `js/gesture.js` - MediaPipe Hands 集成
  - 摄像头初始化与权限处理
  - 张开手掌检测 → 激活抓取资格
  - 握拳检测 → 粒子汇聚动画
  - 持续握拳 1.5秒 → 确认抓取
  - 手势状态回调（palm/fist/none）

### 6. 抓牌动画 ⭐
- [x] `js/card-animations.js` - 动画控制器
  - **3D 卡槽**: 三个金色边框槽位
  - **粒子汇聚**: 金色粒子飘向展示位置
  - **牌面显示**: 直接显示正面（无翻转）
  - **飞入卡槽**: 300ms 缓动动画 + 缩放适配
  - **逆位处理**: Z轴旋转 180°

### 7. 调试工具
- [x] `js/debug-controls.js` - 开发辅助
  - OrbitControls 相机控制
  - WASD/QE 调整卡槽位置
  - 1/2/3 切换选中卡槽
  - P 键输出当前配置到控制台

---

## 当前参数配置

```javascript
// 相机（调试后最终值）
CAMERA_POSITION: { x: 0.0, y: -0.6, z: 7.7 }
CAMERA_LOOKAT: { x: 0.0, y: -1.1, z: 0.0 }

// 卡槽位置
卡槽1: { x: -2.40, y: -2.50, z: -1.00 }
卡槽2: { x: 0.10, y: -2.50, z: -1.00 }
卡槽3: { x: 2.40, y: -2.50, z: -1.00 }

// 粒子汇聚展示位置
displayPosition: { x: 0, y: -0.5, z: 0.5 }

// 卡牌
CARD_WIDTH: 0.7 * 1.2 = 0.84
CARD_HEIGHT: 1.2 * 1.2 = 1.44
cardSpacing: 0.08
星环缩放: 0.3

// 粒子（多色系统）
金色粒子: 2400 (60%)
白色粒子: 1000 (25%)
浅紫粒子: 600 (15%)
opacity: 0.95

// 动画
RING_ROTATION_NORMAL: 60000ms (一圈)
RING_ROTATION_FAST: 10000ms (加速时)
握拳确认时间: 1500ms
```

---

## 待开发模块

### P0: 核心交互 ✅
- [x] `js/card-animations.js` - 牌面动画
  - 粒子汇聚动画
  - 直接显示牌面正面
  - 飞向卡槽（300ms）
  - 逆位牌 Z轴旋转 180°
  - 3D 卡槽管理

- [x] `js/ai-service.js` - AI 解读
  - Claude/Gemini API 流式调用
  - 加载动画
  - 错误处理

### P1: 手势识别 ✅
- [x] `js/gesture.js` - MediaPipe 集成
  - 张开手掌 → 星环加速
  - 握拳 → 粒子汇聚 + 抓取
  - 持续握拳 1.5秒确认
  - 松开拳头取消

- [ ] `js/mouse-fallback.js` - 鼠标降级
  - Raycaster 检测悬停
  - 悬停高亮（发光 + 放大 1.1x）
  - 点击选牌

### P2: 直觉练习
- [ ] `js/intuition-mode.js`
  - 随机抽取 2 张牌
  - 翻牌交互
  - 感受输入框
  - 历史记录

### P3: UI 完善
- [x] 设置弹窗（AI 选择、API Key）
- [ ] 占卜结果展示面板
- [ ] 响应式适配
- [ ] 视觉特效优化

---

## 开发记录

### 2026-02-02
- 初始化项目结构
- 完成 78 张牌数据 (`data/tarot-cards.json`)
- 实现 Three.js 场景基础 (`js/three-scene.js`)
- 完成星环核心视觉效果 (`js/star-ring.js`)
  - 78张牌环形排列，2倍大小
  - 牌背纹理：紫色渐变 + 发光边框 + 星星
  - 金色粒子 4000 个，高斯分布，随机大小
  - 发散光晕效果
  - 60秒/圈旋转动画
- 固定相机视角 `{ x: 17.2, y: 0.2, z: -15.2 }`
- 移除调试用 OrbitControls（可随时恢复）
- 卡牌透明度调整为 1.0（完全不透明）
- 主页面 UI 完成
  - 参考复古神秘风格设计
  - 卡片式布局：象牙白背景 + 柔和阴影
  - 塔罗牌背装饰：紫色渐变 + 金色边框 + 星星 + 发光
  - 标题 `Intuitive Tarot` + 副标题 `连接直觉 · 探索指引`
  - 胶囊按钮：紫色主按钮 + 金色幽灵按钮
  - 色彩系统：奶油黄背景 `#FFFBF2`、紫色 `#7B5EA7`、金色 `#C9A962`
  - 字体：Playfair Display + 系统字体栈
- 占卜页面 UI 完成
  - 星环区域 50% + 底部面板 50% 布局
  - 奶油黄统一背景色（WebGL + CSS 同步）
  - 渲染器启用 sRGB 颜色空间匹配
  - 禁用光晕效果（浅色背景不兼容 AdditiveBlending）
  - 多色粒子系统：金色 60% + 白色 25% + 浅紫色 15%
  - 粒子纹理增强：明亮内核 + 外层光晕
  - 牌背透明度 0.8
  - 三步指示器：张开手掌 → 凝神抽取 → 收入囊中
  - 三个卡槽：过去 / 现在 / 未来
  - 揭示命运按钮（选满3张后激活）
  - 返回按钮紫色配色适配浅色背景

### 2026-02-02 (续)
- 完成手势识别核心功能 (`js/gesture.js`)
  - MediaPipe Hands 集成
  - 张开手掌 → 星环加速 (10秒/圈)
  - 握拳检测 + 1.5秒持续确认
  - 粒子汇聚动画
- 完成抓牌动画系统 (`js/card-animations.js`)
  - 3D 卡槽创建与管理
  - 粒子汇聚动画（金色粒子飘向展示位置）
  - 牌面直接显示正面（无翻转动画）
  - 飞入卡槽动画 + 缩放适配
  - 逆位牌 Z轴旋转 180°
- 优化抓牌流程逻辑
  - 必须先张开手掌激活抓取资格
  - 握拳时先从星环移除牌，再开始粒子汇聚
  - 使用 `pendingCard` 状态管理待抓取的牌
  - 松开拳头放弃抓取
- 修复卡牌透明度问题
  - 设置 `transparent: false` + `alphaTest: 0`
  - 纹理设置 `premultiplyAlpha = false`
- 增强视觉效果
  - 环形粒子 opacity 提升至 0.95
  - 塔罗牌设置为完全不透明
  - 粒子汇聚位置调整至 `{ x: 0, y: -0.5, z: 0.5 }`
- UI 调整
  - 移除卡槽上的"过去/现在/未来"标签
- 修复星环重建功能
  - 添加 `rebuild()` 方法恢复被移除的卡牌
  - 修复方法调用错误 (`createCards` → `createRing`)
  - 仅在非首次进入占卜页面时重建
- 添加调试模式 (`DEBUG_MODE`)
  - OrbitControls 相机控制
  - WASD/QE 调整卡槽位置
  - P 键输出当前配置
- 调试确定最终参数
  - 相机位置: `{ x: 0.0, y: -0.6, z: 7.7 }`
  - 相机目标: `{ x: 0.0, y: -1.1, z: 0.0 }`
  - 卡槽位置: `{ y: -2.50, z: -1.00 }`，x 分别为 -2.40, 0.10, 2.40

### 2026-02-02 (洗牌动画优化)
- 实现洗牌过渡动画 (`star-ring.js`)
  - 紫色粒子先出现，飞向牌的位置（飞到70%）
  - 牌在紫色粒子飞到40%时开始显现
  - 多色粒子平滑渐入，紫色粒子渐出
  - 动画完成后清理紫色粒子
- 优化粒子配置
  - 洗牌紫色粒子：3000个（1200大 + 1000中 + 800小）
  - 多色粒子加倍：金色4800 + 白色2000 + 浅紫1200
  - 最终不透明度提升至 1.0
- 修复渐入跳变问题
  - 移除动画结束时的 `transparent = false` 设置
  - 避免材质重编译导致的一帧跳变
- 预创建所有 3D 对象
  - 卡牌和多色粒子在初始化时预创建
  - 避免动画期间创建对象导致卡顿
- 修复页面状态残留问题
  - `resetUI()` 添加 `cancelParticleConverge()` 清理残留粒子
  - `showMainMenu()` 返回时也清理粒子汇聚
  - 修复第二次进入占卜页面摄像头不开启问题
  - `gesture.js` 的 `init()` 支持重复调用，复用 Hands 实例

### 2026-02-03 (用户引导优化)
- 添加洗牌阶段文字提示
  - 第一段："星辰正在为您排列命运之牌..."（洗牌时显示）
  - 第二段："命运牌阵已就位，请伸出您的手"（牌出现后显示，停留1秒）
  - 星星图标脉冲动画
- 添加手势引导组件
  - 两步引导：张开手掌 → 握紧拳头
  - 当前步骤发光高亮，未激活步骤半透明
  - 张开手掌后切换到第二步发光
  - 成功抓牌后隐藏，下一轮重新显示
- UI 调整
  - 屏蔽三步指示器（`display: none`）
  - "选择三张牌，揭示命运"标题下移（`top: 50px`）
  - 洗牌提示位置调整（`top: 40%`）
  - 手势引导位置调整（`bottom: 150px`）

---

## 当前进度

### 已完成 ✅
- P0 核心功能（数据、场景、星环、动画、AI 解读）
- P1 手势识别（张开手掌、握拳抓取、粒子汇聚）

### 待开发 📋
- P1: 鼠标降级模式（摄像头不可用时）
- P2: 直觉练习模块
- P3: 视觉特效优化

---

## 下一步计划
**实现鼠标降级模式** `js/mouse-fallback.js`
1. 检测摄像头不可用时自动切换
2. Raycaster 检测悬停高亮
3. 点击选牌替代握拳抓取
