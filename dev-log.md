# 星际塔罗师 - 开发日志

## 项目概述
基于 Web 的沉浸式塔罗占卜应用，结合 3D 视觉效果与手势控制。

---

## 已完成模块

### 1. 基础架构
- [x] `js/config.js` - 配置常量（场景、动画、颜色、相机参数）
- [x] `js/state.js` - 应用状态管理
- [x] `js/main.js` - 模块入口与加载测试
- [x] `index.html` - 主页面结构

### 2. 数据层
- [x] `data/tarot-cards.json` - 78张牌完整数据（中英文名、图片URL、关键词）
- [x] `js/tarot-data.js` - 牌数据加载与管理
- [x] `js/storage.js` - LocalStorage 封装

### 3. Three.js 3D 场景
- [x] `js/three-scene.js` - 场景、相机、渲染器、灯光
  - 透明背景渲染
  - 固定相机视角 `{ x: 17.2, y: 0.2, z: -15.2 }`
  - 环境光 + 方向光 + 金色点光源

### 4. 星统环系 ⭐
- [x] `js/star-ring.js` - 核心视觉组件
  - **卡牌环**: 78张牌环形排列，1.2倍大小，间距0.08
  - **牌背纹理**: Canvas 绘制紫色渐变 + 发光边框 + 星星装饰
  - **多色粒子**: 金色2400 + 白色1000 + 浅紫600，高斯分布
  - **星辰纹理**: 圆形径向渐变发光效果
  - **旋转动画**: 60秒/圈（加速时10秒/圈）
  - **粒子飘动**: 缓慢绕圈 + 上下浮动
  - **重建功能**: `rebuild()` 恢复被移除的卡牌

### 5. 手势识别 ⭐
- [x] `js/gesture.js` - MediaPipe Hands 集成
  - 摄像头初始化与权限处理
  - 张开手掌检测 → 激活抓取资格
  - 握拳检测 → 粒子汇聚动画
  - 持续握拳 1秒 → 确认抓取
  - 手势状态回调（palm/fist/none）

### 6. 抓牌动画 ⭐
- [x] `js/card-animations.js` - 动画控制器
  - **3D 卡槽**: 三个金色边框槽位
  - **粒子汇聚**: 金色粒子飘向展示位置
  - **牌面显示**: 直接显示正面（无翻转）
  - **飞入卡槽**: 300ms 缓动动画 + 缩放适配
  - **逆位处理**: Z轴旋转 180°

### 7. 调试工具
- [x] `js/debug-controls.js` - 开发辅助
  - OrbitControls 相机控制
  - WASD/QE 调整卡槽位置
  - 1/2/3 切换选中卡槽
  - P 键输出当前配置到控制台

---

## 当前参数配置

```javascript
// 相机（调试后最终值）
CAMERA_POSITION: { x: 0.0, y: -0.6, z: 7.7 }
CAMERA_LOOKAT: { x: 0.0, y: -1.1, z: 0.0 }

// 卡槽位置
卡槽1: { x: -2.40, y: -2.50, z: -1.00 }
卡槽2: { x: 0.10, y: -2.50, z: -1.00 }
卡槽3: { x: 2.40, y: -2.50, z: -1.00 }

// 粒子汇聚展示位置
displayPosition: { x: 0, y: -1.6, z: 0.5 }

// 卡牌
CARD_WIDTH: 0.7 * 1.2 = 0.84
CARD_HEIGHT: 1.2 * 1.2 = 1.44
cardSpacing: 0.08
星环缩放: 0.3

// 粒子（多色系统）
金色粒子: 2400 (60%)
白色粒子: 1000 (25%)
浅紫粒子: 600 (15%)
opacity: 0.95

// 动画
RING_ROTATION_NORMAL: 70000ms (一圈)
RING_ROTATION_FAST: 10000ms (加速时)
握拳确认时间: 1500ms
```

---

## 待开发模块

### P0: 核心交互 ✅
- [x] `js/card-animations.js` - 牌面动画
  - 粒子汇聚动画
  - 直接显示牌面正面
  - 飞向卡槽（300ms）
  - 逆位牌 Z轴旋转 180°
  - 3D 卡槽管理

- [x] `js/ai-service.js` - AI 解读
  - Claude/Gemini API 流式调用
  - 加载动画
  - 错误处理

### P1: 手势识别 ✅
- [x] `js/gesture.js` - MediaPipe 集成
  - 张开手掌 → 星环加速
  - 握拳 → 粒子汇聚 + 抓取
  - 持续握拳 1秒确认
  - 松开拳头取消

- [ ] `js/mouse-fallback.js` - 鼠标降级
  - Raycaster 检测悬停
  - 悬停高亮（发光 + 放大 1.1x）
  - 点击选牌

### P2: 直觉练习
- [ ] `js/intuition-mode.js`
  - 随机抽取 2 张牌
  - 翻牌交互
  - 感受输入框
  - 历史记录

### P3: UI 完善
- [x] 设置弹窗（AI 选择、API Key）
- [ ] 占卜结果展示面板
- [ ] 响应式适配
- [ ] 视觉特效优化

---

## 开发记录

### 2026-02-02
- 初始化项目结构
- 完成 78 张牌数据 (`data/tarot-cards.json`)
- 实现 Three.js 场景基础 (`js/three-scene.js`)
- 完成星环核心视觉效果 (`js/star-ring.js`)
  - 78张牌环形排列，2倍大小
  - 牌背纹理：紫色渐变 + 发光边框 + 星星
  - 金色粒子 4000 个，高斯分布，随机大小
  - 发散光晕效果
  - 60秒/圈旋转动画
- 固定相机视角 `{ x: 17.2, y: 0.2, z: -15.2 }`
- 移除调试用 OrbitControls（可随时恢复）
- 卡牌透明度调整为 1.0（完全不透明）
- 主页面 UI 完成
  - 参考复古神秘风格设计
  - 卡片式布局：象牙白背景 + 柔和阴影
  - 塔罗牌背装饰：紫色渐变 + 金色边框 + 星星 + 发光
  - 标题 `Intuitive Tarot` + 副标题 `连接直觉 · 探索指引`
  - 胶囊按钮：紫色主按钮 + 金色幽灵按钮
  - 色彩系统：奶油黄背景 `#FFFBF2`、紫色 `#7B5EA7`、金色 `#C9A962`
  - 字体：Playfair Display + 系统字体栈
- 占卜页面 UI 完成
  - 星环区域 50% + 底部面板 50% 布局
  - 奶油黄统一背景色（WebGL + CSS 同步）
  - 渲染器启用 sRGB 颜色空间匹配
  - 禁用光晕效果（浅色背景不兼容 AdditiveBlending）
  - 多色粒子系统：金色 60% + 白色 25% + 浅紫色 15%
  - 粒子纹理增强：明亮内核 + 外层光晕
  - 牌背透明度 0.8
  - 三步指示器：张开手掌 → 凝神抽取 → 收入囊中
  - 三个卡槽：过去 / 现在 / 未来
  - 揭示命运按钮（选满3张后激活）
  - 返回按钮紫色配色适配浅色背景

### 2026-02-02 (续)
- 完成手势识别核心功能 (`js/gesture.js`)
  - MediaPipe Hands 集成
  - 张开手掌 → 星环加速 (10秒/圈)
  - 握拳检测 + 1秒持续确认
  - 粒子汇聚动画
- 完成抓牌动画系统 (`js/card-animations.js`)
  - 3D 卡槽创建与管理
  - 粒子汇聚动画（金色粒子飘向展示位置）
  - 牌面直接显示正面（无翻转动画）
  - 飞入卡槽动画 + 缩放适配
  - 逆位牌 Z轴旋转 180°
- 优化抓牌流程逻辑
  - 必须先张开手掌激活抓取资格
  - 握拳时先从星环移除牌，再开始粒子汇聚
  - 使用 `pendingCard` 状态管理待抓取的牌
  - 松开拳头放弃抓取
- 修复卡牌透明度问题
  - 设置 `transparent: false` + `alphaTest: 0`
  - 纹理设置 `premultiplyAlpha = false`
- 增强视觉效果
  - 环形粒子 opacity 提升至 0.95
  - 塔罗牌设置为完全不透明
  - 粒子汇聚位置调整至 `{ x: 0, y: -0.5, z: 0.5 }`
- UI 调整
  - 移除卡槽上的"过去/现在/未来"标签
- 修复星环重建功能
  - 添加 `rebuild()` 方法恢复被移除的卡牌
  - 修复方法调用错误 (`createCards` → `createRing`)
  - 仅在非首次进入占卜页面时重建
- 添加调试模式 (`DEBUG_MODE`)
  - OrbitControls 相机控制
  - WASD/QE 调整卡槽位置
  - P 键输出当前配置
- 调试确定最终参数
  - 相机位置: `{ x: 0.0, y: -0.6, z: 7.7 }`
  - 相机目标: `{ x: 0.0, y: -1.1, z: 0.0 }`
  - 卡槽位置: `{ y: -2.50, z: -1.00 }`，x 分别为 -2.40, 0.10, 2.40

### 2026-02-02 (洗牌动画优化)
- 实现洗牌过渡动画 (`star-ring.js`)
  - 紫色粒子先出现，飞向牌的位置（飞到70%）
  - 牌在紫色粒子飞到40%时开始显现
  - 多色粒子平滑渐入，紫色粒子渐出
  - 动画完成后清理紫色粒子
- 优化粒子配置
  - 洗牌紫色粒子：3000个（1200大 + 1000中 + 800小）
  - 多色粒子加倍：金色4800 + 白色2000 + 浅紫1200
  - 最终不透明度提升至 1.0
- 修复渐入跳变问题
  - 移除动画结束时的 `transparent = false` 设置
  - 避免材质重编译导致的一帧跳变
- 预创建所有 3D 对象
  - 卡牌和多色粒子在初始化时预创建
  - 避免动画期间创建对象导致卡顿
- 修复页面状态残留问题
  - `resetUI()` 添加 `cancelParticleConverge()` 清理残留粒子
  - `showMainMenu()` 返回时也清理粒子汇聚
  - 修复第二次进入占卜页面摄像头不开启问题
  - `gesture.js` 的 `init()` 支持重复调用，复用 Hands 实例

### 2026-02-03 (用户引导优化)
- 添加洗牌阶段文字提示
  - 第一段："星辰正在为您排列命运之牌..."（洗牌时显示）
  - 第二段："命运牌阵已就位，请依循下方指引，抓取属于您的命运之牌"（牌出现后显示，停留2秒）
  - 星星图标脉冲动画，跟随文字切换颜色（紫色 → 金色）
  - 两段文字重叠定位，平滑切换
  - 时序优化：第一段在牌动画第500ms完全消失，牌完成后50ms第二段出现
- 添加手势引导组件
  - 两步引导：张开手掌 → 握紧拳头
  - 当前步骤发光高亮，未激活步骤半透明
  - 张开手掌后切换到第二步发光
  - 成功抓牌后隐藏，下一轮重新显示
  - 样式优化：白色背景 + 紫色双层光晕（35px + 60px）+ 紫色文字
- UI 调整
  - 屏蔽三步指示器（`display: none`）
  - "选择三张牌，揭示命运"标题下移（`top: 50px`）
  - 洗牌提示位置调整（`top: 40%`）
  - 手势引导位置调整（`bottom: 150px`）
- 添加抓牌方式选择界面
  - 牌出现后显示选择界面：「开启摄像头 · 手势抓牌」/「鼠标点击 · 触碰命运」
  - 摄像头成功：隐藏选择界面，显示手势引导
  - 摄像头失败：标题变「摄像头开启失败」，只显示鼠标按钮
  - 样式：象牙白背景 + 紫色边框发光 + 圆角30px
- 优化抓牌方式选择交互流程
  - 点击「开启摄像头」后选择界面立即消失（无卡顿感）
  - 摄像头后台异步加载，成功后才显示手势引导组件
  - 交互流程：选择界面 → 点击摄像头按钮 → 界面消失 → 摄像头加载 → 成功显示引导/失败显示错误

---

## 当前进度

### 已完成 ✅
- P0 核心功能（数据、场景、星环、动画、AI 解读）
- P1 手势识别（张开手掌、握拳抓取、粒子汇聚）

### 待开发 📋
- P1: 鼠标降级模式（摄像头不可用时）
- P2: 直觉练习模块
- P3: 视觉特效优化

---

## 待优化 🔧

### 1. 手势引导 UI 优化 ✅
- [x] 颜色调整：白色背景 + 紫色双层光晕
- [x] 位置微调：`bottom: 150px`
- [x] 显示策略：摄像头成功后才显示，抓牌后隐藏

### 2. 手势引导逻辑完善 ✅
- [x] 第二步"握紧拳头"只有在先张开手掌后才会发光
- [x] 如果直接握拳（未先张开手掌），第二步不应发光
- [x] 手势引导组件仅在摄像头成功开启后显示（`onCameraReady` 回调中触发）
- [x] 手掌需持续 300ms 才激活第二步（防止短暂误触）
  - 张开手掌立即加速星环，但不立即切换引导
  - 持续 300ms 后才激活抓取资格并切换第二步发光
  - 中途手势消失或握拳则取消计时，保持第一步

### 3. 抓牌取消逻辑修复 ✅
- [x] 松开拳头取消抓取时：
  - 粒子消散动画（向外扩散后淡出）
  - 牌恢复到星环（`starRing.restoreCard()`）
  - 显示取消提示（"握拳时长不够，抓取已取消，牌已归位"）
- [x] 修复粒子动画冲突
  - 添加 `disperseId` 追踪，防止新旧动画互相干扰
  - `startParticleConverge()` 清理残留粒子系统
- [x] 修复手势引导第二步发光问题
  - 手势短暂消失时，引导状态与 `isPalmActivated` 同步
  - 已激活状态下不立即重置引导，等待 800ms 计时器
- [x] 修复粒子消散动画影响新粒子问题
  - 保存当前材质引用 `materialRef = this.convergeMaterial`
  - 消散动画使用保存的引用，不影响新创建的粒子系统
- [x] 修复取消后快速再握拳的问题
  - 添加 `resetFistTimer()` 方法重置握拳计时器
  - 取消抓取时重置 `isPalmActivated = false`
  - 用户必须重新完成完整流程：张开手掌 300ms → 握拳抓取
  - 防止取消后立即握拳跳过手掌检测步骤

### 4. 牌面动画改进 ✅
- [x] 优化动画流程：粒子汇聚 → 粒子淡出+牌背显现 → Y轴翻转 → 飞入卡槽
- [x] 粒子淡出与牌背显现同步进行（500ms）
- [x] 牌背从浅到深渐入显现
- [x] Y轴翻转动画（600ms）增加仪式感
- [x] 双面牌实现（Group + 正反两个 Mesh）
- [x] 逆位牌 Z 轴旋转保持正确

### 5. 星环转速调整 ✅
- [x] 正常速度：70秒/圈（无手势时）
- [x] 快速（张开手掌）：10秒/圈
- [x] 握拳速度：30秒/圈（中速，握拳时从快速切换到此速度）

### 6. UI 微调 ✅
- [x] 粒子汇聚展示位置调整：`{ x: 0, y: -1.6, z: 0.5 }`（避免被星环遮挡）
- [x] 抓牌取消提示文字：「握拳时长不够，抓取已取消，牌已归位」
- [x] 抓牌取消提示样式优化（统一 btn-secondary hover 风格）：
  - 金色背景 `var(--btn-secondary)`
  - 白色文字
  - 金色光晕 `box-shadow: 0 0 20px rgba(218, 190, 120, 0.6)`
  - 微微上浮 `translateY(-2px)`
  - 位置 `bottom: 340px`

### 7. API 配置功能 ✅
- [x] 新增 `js/storage.js` - LocalStorage 封装
  - 保存/读取设置（AI 提供商、API Key、验证状态）
  - 直觉记录和占卜历史管理
- [x] 新增 `js/ai-service.js` - AI API 调用服务
  - 支持 Claude 和 Gemini 两种 API
  - API Key 验证功能
  - 流式响应处理
- [x] 设置按钮（右上角齿轮图标）
  - hover 时旋转 30° + 金色光晕
- [x] 设置弹窗 UI
  - 选择 AI 服务（Gemini 推荐 / Claude）
  - API Key 输入框（密码类型）
  - 验证按钮（验证中/已验证 状态切换）
  - 动态显示获取 API Key 的链接
  - 验证成功后才能保存
- [x] 揭示命运按钮逻辑
  - 未配置 API 时显示提示文字
  - 点击时检查配置，未配置则自动打开设置弹窗

---

### 8. 问题输入页面 ✅
- [x] 新增问题输入页面（主菜单 → 问题页 → 星环页）
  - 顶部：小塔罗牌 Logo + 标题水平排列
  - 扁平输入框（2行高度）
  - 「进入星环」按钮（需输入内容才可点击）
  - 「返回」按钮回到主菜单
- [x] `userQuestion` 状态管理
  - 点击「进入星环」时保存问题
  - 返回主菜单时清空问题
  - 问题页返回时也清空（用户取消占卜）

---

## 下一步计划

### P0: 占卜流程完善 - AI 解读交互

#### 待讨论问题

1. **解读页面布局** ✅
   - [x] 点击「揭示命运」后跳转新页面
   - [x] 三张牌在解读页面缩小显示
   - [x] 如果后续用户抽更多牌，牌展示区域也要跟着更新

2. **AI 输出展示** ✅
   - [x] 先等加载完再显示（后续优化方向：流式逐字显示）
   - [x] 启用 Markdown 渲染（标题、加粗、列表等格式化）

3. **追问功能** ✅
   - [x] 支持追问（解读页面底部有输入框）
   - [x] 无上下文模式：每次追问只发送当前问题 + 牌面信息
   - [ ] 后续优化方向：带上下文的多轮对话

4. **特殊情况处理** ✅
   - [x] AI 调用失败：显示错误原因 + 「重试」按钮
   - [ ] 「多抽一张牌」机制 - 后续优化内容，暂不实现

#### 实现完成 ✅
- [x] 解读结果页面 HTML 结构 (`#result-page`)
- [x] 解读结果页面 CSS 样式（牌面展示、加载状态、错误状态、Markdown 渲染、追问输入）
- [x] 引入 marked.js Markdown 渲染库
- [x] 页面跳转逻辑（星环页 → 结果页 → 返回）
- [x] AI 调用逻辑（加载完成后显示）
- [x] 错误处理 + 重试按钮
- [x] 追问功能（无上下文模式）

#### 已确定
- AI System Prompt 设定词（已在 config.js）

### Prompt 系统 v2.0 ✅ (2026-02-03)
**重构：从双模板升级为三分类智能路由系统**

- [x] **三分类意图识别**
  - **A. 直球结果型 (`direct`)**：Yes/No 问题
    - 关键词：能不能、会不会、是不是、喜不喜欢、能考上、会分手...
    - 特点：结论先行，直给答案
  - **B. 运势预测型 (`fortune`)**：时间段运势
    - 关键词：运势、运气、财运、桃花运、下周、这个月、近期...
    - 特点：像天气预报，能量流动视角
  - **C. 深度分析型 (`analysis`)**：迷茫求建议（默认类型）
    - 关键词：怎么办、为什么、我很迷茫...
    - 特点：讲故事，建立因果连接

- [x] **三套 Prompt 模板**
  - `SYSTEM_PROMPT_DIRECT`：预测结论 → 关键信号 → 变数因素 → 避坑指南
  - `SYSTEM_PROMPT_FORTUNE`：整体运势★ → 能量趋势 → 分领域预测 → 预警 → 开运指南
  - `SYSTEM_PROMPT_ANALYSIS`：核心洞察 → 命运流转（过去/现在/未来）→ 星际指引

- [x] **动态牌阵适配**
  - direct：三牌决断（第一张/第二张/第三张）
  - fortune：能量三角（基础能量/核心趋势/潜在指引）
  - analysis：时间之流（过去/现在/未来）

- [x] **用户消息优化**
  - 增加正逆位统计（X正Y逆）
  - 元素分布一行显示
  - 结构更清晰，便于 AI 快速解析

- [x] Bug 修复：`card.id.startsWith is not a function`
  - 修复：改用 `card.imageFilename` 判断牌类型
- [x] Gemini 两阶段调用架构
  - **阶段1 - 意图识别**：`temperature: 0`，绝对理性，确保返回 A/B/C
  - **阶段2 - 塔罗解读**：`temperature: 1.2` + `topP: 0.95` + `topK: 40`，感性创作
  - 添加 `CLASSIFIER_PROMPT` 分类器提示词
  - 添加 `classifyQuestionWithAI()` 方法
  - 分类失败时自动回退到关键词匹配

### Prompt 系统 v2.1 ✅ (2026-02-03 续)
**新增功能：当前日期感知 + 无效输入过滤**

- [x] **当前日期注入**
  - 三个 Prompt 模板顶部添加 `# 当前日期\n{current_date}`
  - `getReading()` 中动态替换为真实日期（如 "2026年2月3日"）
  - AI 预测"下个月运势"时能正确计算时间

- [x] **无效输入过滤（D 类）**
  - `CLASSIFIER_PROMPT` 新增 D 类（INVALID）
    - 输入过短（"1", "hi", "测试"）
    - 纯数字、乱码、无意义字符
    - 与塔罗无关内容（"写个代码", "今天吃什么"）
  - 双重校验机制：
    - **本地快速校验**：`question.length < 2` 直接拦截（省 API 费用）
    - **AI 分类拦截**：Gemini 返回 D 时抛出友好提示
  - 添加 `INVALID_INPUT_MESSAGE` 友好提示消息

- [x] **追问 Bug 修复**
  - 问题：追问时 Gemini 输出整个 systemPrompt 内容
  - 原因：`callGeminiWithHistory()` 重复拼接 systemPrompt
  - 修复：追问时不再添加 systemPrompt，复用首次解读的角色上下文

### UI 优化 ✅ (2026-02-03)
- [x] AI 解读区域添加边框容器
  - 金色细边框 + 圆角 + 阴影
  - 限制最大宽度 `720px`，居中显示
- [x] 底部追问输入框与解读区域宽度保持一致

### 追问功能增强 ✅ (2026-02-03)
- [x] 追问 UI 改进
  - 保留原答案，追问内容追加显示
  - 用户追问显示紫色背景 + 左边框，带"追问："前缀
  - AI 回答使用独立的金色边框卡片
  - 自动滚动到新内容
- [x] 上下文记忆
  - `conversationHistory` 数组存储对话历史
  - 首次解读：初始化历史（完整牌面信息 + AI 回复）
  - 追问时：传递完整历史给 API，AI 能看到之前所有对话
  - 重新抽牌时自动清空历史
- [x] API 支持多轮对话
  - `callClaudeWithHistory()` - Claude 多轮对话
  - `callGeminiWithHistory()` - Gemini 多轮对话（角色转换 assistant → model）

### P1: 鼠标降级模式
- `js/mouse-fallback.js`
- 检测摄像头不可用时自动切换
- Raycaster 检测悬停高亮
- 点击选牌替代握拳抓取

### P2: 直觉练习模块
- `js/intuition-mode.js`
- 随机抽取 2 张牌
- 翻牌交互
- 感受输入框
- 历史记录

---

## 明日开发计划 (2026-02-04)

### 1. 鼠标降级模式
**文件**: `js/mouse-fallback.js`

**功能点**:
- [ ] 检测摄像头权限被拒绝或不可用时自动切换到鼠标模式
- [ ] Three.js Raycaster 实现鼠标悬停检测
- [ ] 悬停高亮效果（发光 + 放大 1.1x）
- [ ] 点击选牌替代握拳抓取
- [ ] 选牌后直接触发粒子汇聚 + 飞入卡槽动画
- [ ] 与手势模式共用后续流程（卡槽、揭示命运等）

**交互流程**:
1. 用户点击"使用鼠标选牌"或摄像头不可用
2. 星环正常旋转，鼠标悬停牌面高亮
3. 点击牌面 → 触发抓取动画 → 牌飞入卡槽
4. 选满 3 张后显示"揭示命运"按钮

### 2. 直觉练习模块
**文件**: `js/intuition-mode.js`

**功能点**:
- [ ] 首页"直觉练习"按钮入口
- [ ] 随机抽取 2 张牌（背面朝上）
- [ ] 点击翻牌交互（50% 概率逆位）
- [ ] 翻牌后显示感受输入框
- [ ] 输入框 placeholder: "这张牌给你什么感觉？"
- [ ] 保存记录到 LocalStorage（牌名、正逆位、用户感受、时间戳）
- [ ] 历史记录查看页面
- [ ] 记录可在占卜时作为上下文传递给 AI

**数据结构**:
```javascript
{
  id: timestamp,
  cardId: 'c01',
  cardName: '圣杯王牌',
  isReversed: false,
  userFeeling: '感觉很温暖，像是新的开始',
  createdAt: '2026-02-04T10:30:00Z'
}
```

### 3. 新用户引导系统
**功能点**:
- [ ] LocalStorage 存储 `isFirstVisit` 标记
- [ ] 首次访问：
  - 显示欢迎弹窗 / 引导流程
  - 强制进入设置页面配置 API
  - 显示完整的手势引导提示
- [ ] 非首次访问：
  - 跳过欢迎流程
  - 可选择隐藏手势引导提示（设置中添加开关）
  - 记住上次选择的抓牌方式（手势/鼠标）

**设置项新增**:
```javascript
{
  // 现有设置...
  showGestureGuide: true,      // 是否显示手势引导
  preferredInputMode: 'gesture' // 'gesture' | 'mouse'，默认抓牌方式
}
```

**UI 变更**:
- [ ] 设置弹窗增加"显示手势引导"开关
- [ ] 设置弹窗增加"默认抓牌方式"选择
- [ ] 首次访问时的欢迎/引导弹窗设计

### 优先级排序
1. **鼠标降级模式** - 核心功能，提升可用性 ✅
2. **新用户引导** - 提升首次体验
3. **直觉练习** - 增值功能

---

## 开发记录 (续)

### 2026-02-04 (鼠标降级模式)
- 新增 `js/mouse-controller.js` - 鼠标交互控制器
  - 拖拽旋转星环（按住左键拖动）
  - 惯性效果（释放后继续旋转并衰减）
  - 自动恢复星环低速自转
  - 悬停高亮（放大 1.1x + 金色发光）
  - 点击选牌
- `js/three-scene.js` 新增 `addUpdateCallback()` 方法
  - 支持外部注册每帧更新回调
  - 用于鼠标控制器的惯性更新
- `js/main.js` 集成鼠标模式
  - `enableMouseMode()` / `disableMouseMode()` 切换
  - `onMouseCardSelect()` 选牌回调
  - `showMouseModeHint()` 显示操作提示
- 鼠标模式提示 UI
  - 两个并列框：「按住左键拖拽 · 转动命运之轮」「点击牌面 · 选择你的指引」
  - 紫色发光边框
  - 位置：`bottom: 380px`（卡槽上方）
  - 间距：`gap: 50px`
  - 3秒后自动淡出

### 2026-02-04 (视觉优化)
- 洗牌完成文字发光效果
  - 颜色保持金色 `var(--btn-secondary)`
  - 添加强白色发光：`text-shadow: 0 0 5px #fff, 0 0 15px #fff, 0 0 30px rgba(255,255,255,0.8), 0 0 50px rgba(255,255,255,0.5)`
- 洗牌动画时长优化
  - 紫色粒子动画从 1800ms 缩短到 1200ms
  - 整体过渡更快速流畅

### 2026-02-04 (移动端适配优化)
- 移动端横屏布局优化
  - 星环页面底部面板（卡槽 + 揭示命运按钮）上移 55px
  - 媒体查询条件：`max-height: 500px` + `orientation: landscape`
- iPad 横屏布局优化
  - 新增 iPad 横屏媒体查询：`min-width: 768px` ~ `max-width: 1366px` + `orientation: landscape`
  - 底部面板上移 35px
- 直觉练习页面 UI 优化
  - 「保存感受」和「查看历史记录」按钮改为并列显示
  - 两个按钮一直显示（移除条件隐藏逻辑）
  - 「查看历史记录」按钮改为金色样式 `btn-secondary`

### 2026-02-04 (网站部署)
- Vercel 部署完成
  - 仓库：GitHub tarot-project
  - 临时域名：https://mytarot-project.vercel.app
  - 状态：已上线运行
- 自定义域名绑定完成
  - 域名：https://mystartarot.xyz
  - DNS：阿里云解析 → Vercel
  - 国内访问：已优化

### 2026-02-05 (v0.6: 内置 API + 兑换码系统)

#### 已完成
- **内置 API Key + 兑换码系统**
  - 内置默认 Gemini API Key，新用户免配置直接可用
  - 每人默认 3 次免费使用（localStorage 计数）
  - 兑换码系统：7 个初始码（STAR-xxxx），每码 3 次
  - 设置弹窗新增兑换码输入区域
  - 次数用尽弹窗提示
  - 占卜页面显示剩余次数
  - 涉及文件：config.js、storage.js、main.js、index.html
- **禁用直觉练习功能**
  - 隐藏主菜单「直觉练习」按钮
  - 隐藏问题页面「注入能量」开关
  - 代码保留不删，只隐藏 UI 入口
- **新增兑换码管理文件** `兑换码管理.md`

- **移动端摄像头/手势选项**
  - 移除触屏设备自动跳过逻辑，移动端和桌面端统一显示选择弹窗
  - 移动端按钮文案适配：「触屏点击 · 触碰命运」
  - 摄像头需 HTTPS 环境，HTTP 下自动回退
- **Bug 修复**
  - 使用次数递减后界面不刷新 → 增量后立即调用 `updateApiHintVisibility()`
  - 无效输入也消耗次数（防滥用）
  - 兑换状态消息 3 秒自动消失 + 关闭弹窗时清空
  - 新一次占卜时追问状态正确重置
  - 追问上限 3 次，达到后输入框禁用
- **API Key 输入框锁定**
  - 当前版本仅支持内置 Key，API Key 输入框、验证按钮、AI 提供商选择均禁用
  - 显示掩码 placeholder「●●●●●●●● 内置体验 Key」

#### 手机竖屏 UI 优化
- **横竖屏方向提示**（纯 CSS 实现）
  - 手机横屏（≤932px + landscape）→ 遮罩「请旋转设备至竖屏使用」
  - iPad 竖屏（768-1366px + portrait）→ 遮罩「请旋转设备至横屏使用」
  - 遮罩样式：卡片式设计（紫色边框 + 光晕 + 圆角30px），与抓牌选择弹窗风格一致
- **手机端 3D 卡槽优化**
  - 卡槽尺寸：1.4×2.4 → 1.0×1.6（经多轮调试）
  - 卡槽位置：对称居中 x: -1.40, 0.00, 1.40（中心距 1.4）
  - 左右边缘 ±1.90，接近可视极限 ±1.87，视觉饱满
  - 修复飞入卡槽缩放比例：`playFlyToSlot()` 中 scaleRatio 适配手机端卡槽宽度（1.0/1.8 替代硬编码 1.4/1.8）
- **选择弹窗/引导位置上移**
  - `.camera-fallback` bottom: 120px → 240px
  - `.gesture-guide` 添加手机端规则 bottom: 240px
- **修复"命运牌阵已就位"竖排文字**
  - 手机端 `.shuffle-hint` 加 `width: 80vw`
- **手机端「点击选牌」提示简化**
  - 触屏设备改用 `showTouchModeHint()`，单个居中提示框
  - 位置 `top: 42%` 与洗牌提示同高度
  - 修复 `fadeInUp` 动画与 `translate(-50%, -50%)` 冲突导致的跳动，改用 `fadeIn`
- **"揭示命运"按钮上移**
  - 手机端 `.reading-panel` 用 `transform: translateY(-25px)` 上移（避免 layout 跳动）

#### iPad 横屏 UI 优化
- **3D 卡槽位置上移**
  - 新增 iPad 设备判断（768-1366px + 触屏）
  - iPad 卡槽 y 坐标：-2.50 → -2.15，位置上移更贴合横屏视觉

#### Bug 修复
- **修复无效输入不扣使用次数**
  - 原因：`ai-service.js` 中短输入（< 2 字符）通过 `throw new Error()` 抛出，直接进入 `catch` 块，跳过了 `try` 中的 `incrementUsageCount()`
  - 修复：在 `callAIReading()` 的 `catch` 块中补充判断，若为首次解读 + 内置 Key + 错误信息为无效输入提示，则同样扣次数
- **手机端取消抓牌提示位置调整**
  - 手机端 `.grab-cancel-hint` bottom: 340px → 300px，位于手势引导上方
- **全模块缓存刷新**
  - 所有 JS import 统一加 `?v=10`，`index.html` script 标签同步更新，防止浏览器缓存旧代码

#### 已确认无需处理
- 多人同时使用：API 独立调用，互不影响
- 直觉数据隔离：localStorage 本地存储，互不可见
- App 开发：后续考虑
